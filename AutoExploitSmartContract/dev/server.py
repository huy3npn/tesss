from web3 import Web3
from flask import Flask, flash, request, redirect, url_for
from lib.utils import *
import os, json

# Flask HTTP-server
app = Flask(__name__)
HOST = '127.0.0.1'
PORT = '5000'

# Web3 Provider
Provider = 'http://127.0.0.1:8545'
w3 = Web3(Web3.HTTPProvider(Provider))
accounts_list = w3.eth.accounts

# contract manager
SCM = ContractManager(w3_provider=w3, accounts=accounts_list)

@app.route("/compile", methods=['POST'])
def compile_sol():
    # try:
    result = SCM.compile_sol(solfile=request.form.get('solfile'))
    return (result, 200)
    # except Exception as err:
    #     return (str(err),400)
    
@app.route('/deploy', methods=['POST'])
def deploy():
    # try:
    result = SCM.deploy(contract_name=request.form.get('contract'))
    return (result, 200)
    # except Exception as err:
    #     return (str(err),400)

# Recieve action & execute function
# contract_name=CrowSale&function_name=setPhase(1)
@app.route("/execute", methods=['POST'])
def execute():
    # try:
    result = SCM.execute(contract = request.form.get('contract'), function = request.form.get('function'))
    return (result, 200)
    # except Exception as err:
    #     return (str(err),400)
        


# @app.route('/upload', methods=['GET', 'POST'])
# def upload_file():
#     if request.method == 'POST':
#         # check if the post request has the file part
#         if 'file' not in request.files:
#             flash('No file part')
#             return redirect(request.url)
#         file = request.files['file']
#         # If the user does not select a file, the browser submits an
#         # empty file without a filename.
#         if file.filename == '':
#             flash('No selected file')
#             return redirect(request.url)
#         filename = secure_filename(file.filename)
#         file.save(os.path.join('./uploads', filename))
#         return redirect()
#     else:
#         return '''
#         <!doctype html>
#         <title>Upload new File</title>
#         <h1>Upload new File</h1>
#         <form method=post enctype=multipart/form-data>
#         <input type=file name=file>
#         <input type=submit value=Upload>
#         </form>
#         '''


if __name__ == "__main__":
    app.run(HOST, PORT, debug=False)